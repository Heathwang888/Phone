<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <!-- 前面的 head 部分保持不變 -->
  [之前的 meta 標籤和 style 部分保持不變]
</head>
<body>
  <div class="app-header">手機對保合約</div>
  
  <div class="container">
    <form id="dataForm" autocomplete="off">
      <!-- 表單內容保持不變 -->
      [之前的表單內容]
    </form>
    <div class="bottom-spacing"></div>
  </div>

  <div class="button-group">
    <button type="button" onclick="fillContract()">套入合約資料</button>
    <button type="button" onclick="downloadPDF()" id="downloadBtn" disabled>下載 PDF</button>
  </div>

  <div class="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- 合約頁面容器 -->
  <div class="page-container">
    <!-- PAGE 1 -->
    <div class="page" id="contractPage1" style="background-image: url('images/page1.jpg');">
      <!-- 出賣人 -->
      <div class="field" id="sellerNameField" style="top:310px; left:350px;"></div>
      <div class="field" id="sellerIdField" style="top:310px; left:750px;"></div>
      <div class="field" id="sellerAddressField" style="top:390px; left:350px;"></div>
      <!-- 標的物 -->
      <div class="field" id="phoneModelField" style="top:660px; left:500px;"></div>
      <div class="field" id="brandField" style="top:660px; left:300px;">APPLE</div>
      <div class="field" id="imeiField" style="top:660px; left:830px;"></div>
      <!-- 交易總價 -->
      <div class="field" id="totalPriceField" style="top:920px; left:500px;"></div>
      <!-- 行庫分行、戶名、帳號 -->
      <div class="field" id="bankBranchField" style="top:1090px; left:400px;"></div>
      <div class="field" id="accountNameField" style="top:1090px; left:750px;"></div>
      <div class="field" id="accountNumberField" style="top:1090px; left:1020px;"></div>
      <!-- 最下方身分證字號 -->
      <div class="field" id="signerIdField" style="top:1800px; left:400px;"></div>
      <!-- 年月日 -->
      <div class="field" id="yearField" style="top:1885px; left:450px;"></div>
      <div class="field" id="monthField" style="top:1885px; left:820px;"></div>
      <div class="field" id="dayField" style="top:1885px; left:1150px;"></div>
    </div>

    <!-- PAGE 2 -->
    <div class="page" id="contractPage2" style="background-image: url('images/page2.jpg');">
      <!-- 立契約書人 -->
      <div class="field" id="contractorNameField" style="top:198px; left:380px;"></div>
      <!-- 手機廠牌 -->
      <div class="field" id="brandField" style="top:410px; left:280px;">APPLE</div>
      <!-- 手機型號 -->
      <div class="field" id="model2Field" style="top:410px; left:530px; letter-spacing:0px;"></div>
      <!-- IMEI -->
      <div class="field" id="imei2Field" style="top:410px; left:800px; letter-spacing:0px;"></div>
      <!-- 總價值 -->
      <div class="field" id="price2Field" style="top:410px; left:1100px;"></div>
      <!-- 租賃期間 -->
      <div class="field" id="startYearField" style="top:555px; left:535px;"></div>
      <div class="field" id="startMonthField" style="top:555px; left:625px;"></div>
      <div class="field" id="startDayField" style="top:555px; left:700px;"></div>
      <div class="field" id="endYearField" style="top:555px; left:830px;"></div>
      <div class="field" id="endMonthField" style="top:555px; left:915px;"></div>
      <div class="field" id="endDayField" style="top:555px; left:995px;"></div>
      <!-- 租金 -->
      <div class="field" id="rent2Field" style="top:625px; left:500px;"></div>
      <!-- 最下方地址、身分證字號 -->
      <div class="field" id="address2Field" style="top:1825px; left:300px; letter-spacing:0px;"></div>
      <div class="field" id="id2Field" style="top:1780px; left:360px;"></div>
      <!-- 年月日（簽約日） -->
      <div class="field" id="year2Field" style="top:1890px; left:450px;"></div>
      <div class="field" id="month2Field" style="top:1890px; left:810px;"></div>
      <div class="field" id="day2Field" style="top:1890px; left:1160px;"></div>
    </div>

    <!-- PAGE 3 -->
    <div class="page" id="contractPage3" style="background-image: url('images/page3.jpg');">
      <!-- 最下方身分證字號 -->
      <div class="field" id="signerId3Field" style="top:1360px; left:345px;"></div>
      <!-- 年月日 -->
      <div class="field" id="year3Field" style="top:1880px; left:450px;"></div>
      <div class="field" id="month3Field" style="top:1880px; left:750px;"></div>
      <div class="field" id="day3Field" style="top:1880px; left:1050px;"></div>
    </div>
  </div>

  <script>
    // 註冊 Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // 格式化數字（加上千分位）
    function formatNumber(num) {
      if (!num || isNaN(num)) return num;
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 轉換為民國年日期
    function toTaiwanDateParts(date) {
      const y = date.getFullYear() - 1911;
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return { year: y, month: m, day: d };
    }

    // 增加天數
    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    // 填入合約資料
    function fillContract() {
      // PAGE 1
      document.getElementById('sellerNameField').innerText = document.getElementById('name').value;
      document.getElementById('sellerIdField').innerText = document.getElementById('id').value;
      document.getElementById('sellerAddressField').innerText = document.getElementById('address').value;
      document.getElementById('phoneModelField').innerText = document.getElementById('model').value;
      document.getElementById('imeiField').innerText = document.getElementById('imei').value;
      document.getElementById('totalPriceField').innerText = formatNumber(document.getElementById('price').value);
      document.getElementById('bankBranchField').innerText = document.getElementById('bank').value;
      document.getElementById('accountNameField').innerText = document.getElementById('accountName').value;
      document.getElementById('accountNumberField').innerText = document.getElementById('account').value;
      document.getElementById('signerIdField').innerText = document.getElementById('id').value;

      const today = new Date();
      const taiwan = toTaiwanDateParts(today);
      document.getElementById('yearField').innerText = taiwan.year;
      document.getElementById('monthField').innerText = taiwan.month;
      document.getElementById('dayField').innerText = taiwan.day;

      // PAGE 2
      document.getElementById('contractorNameField').innerText = document.getElementById('name').value;
      document.getElementById('model2Field').innerText = document.getElementById('model').value;
      document.getElementById('imei2Field').innerText = document.getElementById('imei').value;
      document.getElementById('price2Field').innerText = formatNumber(document.getElementById('price').value);
      document.getElementById('startYearField').innerText = taiwan.year;
      document.getElementById('startMonthField').innerText = taiwan.month;
      document.getElementById('startDayField').innerText = taiwan.day;

      const endDate = addDays(today, 7);
      const endTaiwan = toTaiwanDateParts(endDate);
      document.getElementById('endYearField').innerText = endTaiwan.year;
      document.getElementById('endMonthField').innerText = endTaiwan.month;
      document.getElementById('endDayField').innerText = endTaiwan.day;

      document.getElementById('rent2Field').innerText = formatNumber(document.getElementById('rent').value);
      document.getElementById('address2Field').innerText = document.getElementById('address').value;
      document.getElementById('id2Field').innerText = document.getElementById('id').value;
      document.getElementById('year2Field').innerText = taiwan.year;
      document.getElementById('month2Field').innerText = taiwan.month;
      document.getElementById('day2Field').innerText = taiwan.day;

      // PAGE 3
      document.getElementById('signerId3Field').innerText = document.getElementById('id').value;
      document.getElementById('year3Field').innerText = taiwan.year;
      document.getElementById('month3Field').innerText = taiwan.month;
      document.getElementById('day3Field').innerText = taiwan.day;

      // 啟用下載按鈕
      document.getElementById('downloadBtn').disabled = false;
    }

    // 顯示載入動畫
    function showLoading() {
      document.querySelector('.loading-overlay').style.display = 'flex';
    }

    // 隱藏載入動畫
    function hideLoading() {
      document.querySelector('.loading-overlay').style.display = 'none';
    }

    // 下載 PDF
    async function downloadPDF() {
      showLoading();
      const jsPDF = window.jspdf.jsPDF;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pages = [
        document.getElementById('contractPage1'),
        document.getElementById('contractPage2'),
        document.getElementById('contractPage3')
      ];

      try {
        for (let i = 0; i < pages.length; i++) {
          await new Promise((resolve) => {
            const bg = pages[i].style.backgroundImage;
            if (!bg) return resolve();
            
            const url = bg.slice(5, -2);
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = resolve;
            img.onerror = () => {
              console.error('Image failed to load:', url);
              resolve();
            };
            img.src = url;
          });

          const canvas = await html2canvas(pages[i], {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            logging: true,
            onclone: function(clonedDoc) {
              const clonedElement = clonedDoc.getElementById(`contractPage${i+1}`);
              if (clonedElement) {
                clonedElement.style.visibility = 'visible';
                clonedElement.style.display = 'block';
                clonedElement.style.position = 'relative';
                clonedElement.style.left = '0';
              }
            }
          });

          const imgData = canvas.toDataURL('image/jpeg', 1.0);
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        }

        const name = document.getElementById('name').value || '合約';
        pdf.save(`${name}-手機對保合約.pdf`);
      } catch (error) {
        console.error('PDF generation failed:', error);
        alert('PDF 生成失敗，請稍後再試');
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
