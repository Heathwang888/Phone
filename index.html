<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機對保正式版合約</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 20px;
        }
        button:hover {
            background: #1557b0;
        }
        .contract-page { 
            width: 210mm; 
            height: 297mm; 
            padding: 25mm; 
            background: white; 
            margin: 20px auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        #contractContent {
            display: none;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        .section-title {
            font-weight: bold;
            margin-top: 15px;
            color: #333;
        }
        p {
            margin: 6px 0;
            line-height: 1.6;
        }
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>手機對保資料填寫</h1>
            <form id="dataForm">
                <div class="form-group">
                    <label for="name">客戶姓名</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="id">身分證字號</label>
                    <input type="text" id="id" required>
                </div>
                
                <div class="form-group">
                    <label for="address">地址</label>
                    <input type="text" id="address" required>
                </div>
                
                <div class="form-group">
                    <label for="imei">IMEI碼</label>
                    <input type="text" id="imei" required>
                </div>
                
                <div class="form-group">
                    <label for="price">交易總價（元）</label>
                    <input type="number" id="price" required>
                </div>
                
                <div class="form-group">
                    <label for="rent">每日租金（元）</label>
                    <input type="number" id="rent" required>
                </div>
                
                <div class="form-group">
                    <label for="bank">行庫分行</label>
                    <input type="text" id="bank" required>
                </div>
                
                <div class="form-group">
                    <label for="accountName">戶名</label>
                    <input type="text" id="accountName" required>
                </div>
                
                <div class="form-group">
                    <label for="accountNumber">帳號</label>
                    <input type="text" id="accountNumber" required>
                </div>
                
                <div class="form-group">
                    <label for="model">手機型號</label>
                    <select id="model" required>
                        <option value="">請選擇型號</option>
                        <option>iPhone 12</option>
                        <option>iPhone 12 mini</option>
                        <option>iPhone 12 Pro</option>
                        <option>iPhone 12 Pro Max</option>
                        <option>iPhone 13</option>
                        <option>iPhone 13 mini</option>
                        <option>iPhone 13 Pro</option>
                        <option>iPhone 13 Pro Max</option>
                        <option>iPhone 14</option>
                        <option>iPhone 14 Plus</option>
                        <option>iPhone 14 Pro</option>
                        <option>iPhone 14 Pro Max</option>
                        <option>iPhone 15</option>
                        <option>iPhone 15 Plus</option>
                        <option>iPhone 15 Pro</option>
                        <option>iPhone 15 Pro Max</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="capacity">容量</label>
                    <select id="capacity" required>
                        <option value="">請選擇容量</option>
                        <option>128G</option>
                        <option>256G</option>
                        <option>512G</option>
                        <option>1TB</option>
                    </select>
                </div>

                <button type="button" onclick="generateContract()">產生PDF合約</button>
            </form>
        </div>

        <div id="contractContent">
            <!-- 合約內容與您提供的相同 -->
            <div class="contract-page" id="page1">
                <!-- 買賣契約內容 -->
                <h2>中古手機買賣契約</h2>
                <p>買受人茲確認已於簽訂本契約前攜回審閱且充分明瞭本契約，並同意日後不爭執審閱期間及本契約內容。</p>

                <p><b>出賣人</b></p>
                <p>姓名：<span id="outName"></span>　身分證字號：<span id="outId"></span></p>
                <p>地址：<span id="outAddress"></span></p>

                <p><b>標的物</b></p>
                <p>手機廠牌：APPLE　手機型號：<span id="outModel"></span>　IMEI碼：<span id="outImei"></span></p>

                <p><b>標的物現況</b></p>
                <p>有無動產抵押及其他負擔：□無 □有　債權人：______ 抵押(負擔)金額：______</p>
                <p>有以下瑕疵狀況：</p>
                <p>□螢幕觸控異常 □螢幕破裂 □螢幕顯示功能異常 □充電功能異常 □實體部件異常(音量鍵、電源鍵、靜音切換鍵等)</p>
                <p>□訊號接收異常 □生物辨識功能異常 □相機(鏡頭)功能異常 □聽筒與麥克風異常 □SIM卡讀取異常 □喇叭及震動功能異常</p>

                <p><b>價金給付方式</b></p>
                <p>交易總價：新台幣<span id="outPrice"></span>元整。</p>
                <p>交易總價即指買受人應給付之全部價金，出賣人不得再以其他名義，要求買受人給付額外之金額。</p>
                <p>以現金匯付至下列指定帳戶：</p>
                <p>行庫分行：<span id="outBank"></span>　戶名：<span id="outAccountName"></span>　帳號：<span id="outAccountNumber"></span></p>

                <p><b>交付方式</b></p>
                <p>出賣人與買受人約定以民法761條所規定之占有改定為交付方式，讓買受人取得間接占有。</p>

                <p><b>保固責任</b></p>
                <p>出賣人及買受人同意以現況交付，出賣人不負瑕疵擔保責任。</p>

                <p><b>其他約定事項</b></p>
                <p>一、出賣人擔保本件標的非贓物，且無來路不明、產權糾紛或其他權利瑕疵之情事。</p>
                <p>二、出賣人擔保本件標的未曾發生重大損壞或更改原廠設定。</p>
                <p>三、標的物之利益及危險，自交付日起，由買受人承受即負擔，但若出賣人仍占有使用手機，擇由出賣人承受即負擔。</p>
                <p>四、本契約訂定後，若有任何增刪修改，須經雙方當事人書面同意。</p>
                <p>五、本契約若有未盡事宜，由雙方本誠信原則協議之。如有涉訟依臺灣高雄地方法院為第一審管轄法院。</p>
                <p>六、本契約書正本壹式貳份，由買受人及出賣人各執一份正本。</p>
                <p>七、雙方同意以電子方式簽屬本契約書。</p>

                <br>
                <p>立契約書人：</p>
                <p>出賣人：<span id="outName2"></span>（簽章）　買受人：<span id="buyerName2"></span>（簽章）</p>
                <p>身分證字號：<span id="outId2"></span>　身分證字號：<span id="buyerId2"></span></p>
                <p>中 華 民 國　<span id="outYear"></span>年　<span id="outMonth"></span>月　<span id="outDay"></span>日</p>
            </div>

            <div class="contract-page" id="page2">
                <!-- 租賃契約內容 -->
                <h2>手機租賃契約</h2>
                <p><b>承租人資料</b></p>
                <p>姓名：<span id="rentName"></span>　身分證字號：<span id="rentId"></span></p>
                <p>地址：<span id="rentAddress"></span></p>

                <p><b>租賃標的</b></p>
                <p>手機型號：<span id="rentModel"></span>　容量：<span id="rentCapacity"></span></p>
                <p>IMEI碼：<span id="rentImei"></span></p>

                <p><b>租金及付款方式</b></p>
                <p>每日租金：新台幣<span id="rentDayPrice"></span>元整</p>

                <p><b>租賃期間</b></p>
                <p>自 <span id="rentStart"></span> 起至 <span id="rentEnd"></span> 止</p>

                <br>
                <p>立契約書人：</p>
                <p>承租人：<span id="rentNameSign"></span>（簽章）</p>
                <p>中 華 民 國　<span id="rentSignDate"></span></p>
            </div>

            <div class="contract-page" id="page3">
                <!-- 切結書內容 -->
                <h2>切結書</h2>
                <p>立切結書人：<span id="swearName"></span></p>
                <p>身分證字號：<span id="swearId"></span></p>
                <p>地址：<span id="swearAddress"></span></p>

                <p>本人切結如下：</p>
                <p>一、本人所提供之個人資料均為真實。</p>
                <p>二、本人保證所交付之手機為合法取得，無任何權利瑕疵。</p>
                <p>三、如有不實，願負相關法律責任。</p>

                <br>
                <p>立切結書人：<span id="swearNameSign"></span>（簽章）</p>
                <p>中 華 民 國　<span id="swearDate"></span></p>
            </div>
        </div>
    </div>

    <div class="loading" id="loadingIndicator">
        正在生成PDF，請稍候...
    </div>

    <script>
        function toTaiwanDate(date) {
            const year = date.getFullYear() - 1911;
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}年${month}月${day}日`;
        }

        async function generateContract() {
            // 顯示載入指示器
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                // 顯示合約內容（暫時）
                document.getElementById('contractContent').style.display = 'block';

                // 取得表單資料
                const formData = {
                    name: document.getElementById('name').value,
                    id: document.getElementById('id').value,
                    address: document.getElementById('address').value,
                    imei: document.getElementById('imei').value,
                    price: document.getElementById('price').value,
                    rent: document.getElementById('rent').value,
                    model: document.getElementById('model').value,
                    capacity: document.getElementById('capacity').value,
                    bank: document.getElementById('bank').value,
                    accountName: document.getElementById('accountName').value,
                    accountNumber: document.getElementById('accountNumber').value
                };

                // 驗證必填欄位
                for (let key in formData) {
                    if (!formData[key]) {
                        alert('請填寫所有必填欄位');
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('contractContent').style.display = 'none';
                        return;
                    }
                }

                const today = new Date();
                const endDate = new Date(today);
                endDate.setDate(today.getDate() + 7);

                // 更新所有合約欄位
                const fields = {
                    // 買賣契約
                    'outName': formData.name,
                    'outId': formData.id,
                    'outAddress': formData.address,
                    'outModel': formData.model,
                    'outImei': formData.imei,
                    'outPrice': formData.price,
                    'outBank': formData.bank,
                    'outAccountName': formData.accountName,
                    'outAccountNumber': formData.accountNumber,
                    'outName2': formData.name,
                    'outId2': formData.id,
                    
                    // 租賃契約
                    'rentName': formData.name,
                    'rentId': formData.id,
                    'rentAddress': formData.address,
                    'rentModel': formData.model,
                    'rentCapacity': formData.capacity,
                    'rentImei': formData.imei,
                    'rentDayPrice': formData.rent,
                    'rentNameSign': formData.name,
                    
                    // 切結書
                    'swearName': formData.name,
                    'swearId': formData.id,
                    'swearAddress': formData.address,
                    'swearNameSign': formData.name
                };

                // 更新所有日期欄位
                document.getElementById('rentStart').innerText = toTaiwanDate(today);
                document.getElementById('rentEnd').innerText = toTaiwanDate(endDate);
                document.getElementById('rentSignDate').innerText = toTaiwanDate(today);
                document.getElementById('swearDate').innerText = toTaiwanDate(today);

                // 更新所有欄位值
                for (let id in fields) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.innerText = fields[id];
                    }
                }

                // 生成PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pages = document.querySelectorAll('.contract-page');

                for (let i = 0; i < pages.length; i++) {
                    const canvas = await html2canvas(pages[i], {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                }

                // 保存PDF
                pdf.save(`${formData.name}-手機對保合約.pdf`);

            } catch (error) {
                console.error('PDF生成錯誤:', error);
                alert('生成PDF時發生錯誤，請稍後再試');
            } finally {
                // 隱藏載入指示器和合約內容
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('contractContent').style.display = 'none';
            }
        }
    </script>
</body>
</html>
